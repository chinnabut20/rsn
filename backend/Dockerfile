# ‡πÉ‡∏ä‡πâ Python slim image (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö TensorFlow 2.20 + NumPy 2.x)
FROM python:3.10-slim

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î working directory
WORKDIR /app

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á system dependencies ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
RUN apt-get update && apt-get install -y \
    libgl1 \
    libglib2.0-0 \
    build-essential \
    gcc \
    gfortran \
    libhdf5-dev \
    libatlas-base-dev \
    liblapack-dev \
    && rm -rf /var/lib/apt/lists/*

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å requirements.txt ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
COPY requirements.txt .

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á torch/torchvision (CPU version)
RUN pip install --no-cache-dir torch==2.2.2 torchvision==0.17.2 --index-url https://download.pytorch.org/whl/cpu

# üî• ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏° requirements.txt (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏á)
RUN pip install --no-cache-dir -r requirements.txt

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ã‡∏≠‡∏£‡πå‡∏™‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
COPY . .

# ‡πÄ‡∏õ‡∏¥‡∏î port FastAPI
EXPOSE 8000

# ‡∏£‡∏±‡∏ô FastAPI
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
